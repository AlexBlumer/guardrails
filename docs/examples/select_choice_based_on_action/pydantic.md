# Enforcing Guardrails on Choice Selection

!!! note
    To download this tutorial as a Jupyter notebook, click [here](https://github.com/ShreyaR/guardrails/blob/main/docs/examples/select_choice_based_on_action.ipynb).

In this example, we want the LLM to pick an action (e.g. `fight` or `flight`), and based on that action we want to return different JSON objects. For example, if the action is `fight`, we want to return a JSON object that contains the `weapon` field. If the action is `flight`, we want to return a JSON object that contains the `direction` and `distance` fields.

We make the assumption that:

1. We don't need any external libraries that are not already installed in the environment.
2. We are able to execute the code in the environment.

## Objective

We want the LLM to play an RP game where it can choose to either `fight` or `flight`. If it chooses to `fight`, the LLM should choose a `weapon` and an `enemy`. If the player chooses `flight`, the LLM should choose a `direction` and a `distance`.


## Step 1: Generating `RAIL` Spec

Ordinarily, we could create a separate `RAIL` spec in a file. However, for the sake of this example, we will generate the `RAIL` spec in the notebook as a string or a Pydantic Model.

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! Instead, edit the notebook w/the location & name as this file. -->

XML option:


```python
import os
os.environ["OPENAI_API_KEY"] = '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'
rail_str = """
<rail version="0.1">

<output>
    <choice name="action" on-fail-choice="reask" discriminator="chosen_action">
        <case name="fight">
            <string name="weapon" format="valid-choices: {['crossbow', 'machine gun']}" on-fail-valid-choices="reask" />
        </case>
        <case name="flight">
            <string name="flight_direction" format="valid-choices: {['north','south','east','west']}" on-fail-valid-choices="exception" />
            <integer name="distance" format="valid-choices: {[1,2,3,4]}" on-fail-valid-choices="exception" />
        </case>
    </choice>
</output>

<prompt>
You are a human in an enchanted forest. You come across opponents of different types, and you should fight smaller opponents and run away from bigger ones.

You run into a ${opp_type}. What do you do?

${gr.complete_json_suffix_v2}</prompt>

</rail>
"""
```

Pydantic model option:


```python
from guardrails.validators import ValidChoices
from pydantic import BaseModel, Field
from typing import Literal, Union

prompt = """
You are a human in an enchanted forest. You come across opponents of different types, and you should fight smaller opponents and run away from bigger ones.

You run into a ${opp_type}. What do you do?

${gr.complete_json_suffix_v2}"""

class Fight(BaseModel):
    chosen_action: Literal['fight']
    weapon: str = Field(validators=[ValidChoices(['crossbow', 'machine gun'], on_fail="reask")])

class Flight(BaseModel):
    chosen_action: Literal['flight']
    flight_direction: str = Field(validators=[ValidChoices(['north','south','east','west'], on_fail="exception")])
    distance: int = Field(validators=[ValidChoices([1,2,3,4], on_fail="exception")])

class FightOrFlight(BaseModel):
    action: Union[Fight, Flight] = Field(discriminator='chosen_action')
```

## Step 2: Create a `Guard` object with the RAIL Spec

We create a `gd.Guard` object that will check, validate and correct the generated code. This object:

1. Enforces the quality criteria specified in the RAIL spec (i.e. bug free code).
2. Takes corrective action when the quality criteria are not met (i.e. reasking the LLM).
3. Compiles the schema and type info from the RAIL spec and adds it to the prompt.

From XML:


```python
import guardrails as gd

from rich import print

guard = gd.Guard.from_rail_string(rail_str)
```

Or from Pydantic:


```python
import guardrails as gd

from rich import print

guard = gd.Guard.from_pydantic(output_class=FightOrFlight, prompt=prompt)
```

The `Guard` object compiles the output schema and adds it to the prompt. We can see the final prompt below:


```python
print(guard.base_prompt)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><br />You are a human in an enchanted forest. You come across opponents of different types, and you should fight smaller <br />opponents and run away from bigger ones.<br /><br />You run into a $<span style=\"font-weight: bold\">{</span>opp_type<span style=\"font-weight: bold\">}</span>. What do you do?<br /><br /><br />Given below is XML that describes the information to extract from this document and the tags to extract it into.<br /><br /><span style=\"font-weight: bold\">&lt;</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff; font-weight: bold\">output</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">    &lt;choice </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"action\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">discriminator</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"chosen_action\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">        &lt;case </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"fight\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">            &lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"weapon\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"valid-choices: choices=['crossbow', 'machine gun']\"</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">        &lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">case</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">        &lt;case </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"flight\"</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">            &lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"flight_direction\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"valid-choices: choices=['north', 'south', 'east', 'west']\"</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">            &lt;integer </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"distance\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"valid-choices: choices=[1, 2, 3, 4]\"</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">        &lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">case</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">    &lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">choice</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">output</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;</span><br /><br /><br /><span style=\"color: #000000; text-decoration-color: #000000\">ONLY return a valid JSON object </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">(</span><span style=\"color: #000000; text-decoration-color: #000000\">no other text is necessary</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">)</span><span style=\"color: #000000; text-decoration-color: #000000\">, where the key of the field in JSON is the `name` </span><br /><span style=\"color: #000000; text-decoration-color: #000000\">attribute of the corresponding XML, and the value is of the type specified by the corresponding XML's tag. The JSON</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">MUST conform to the XML format, including any types and format requests e.g. requests for lists, objects and </span><br /><span style=\"color: #000000; text-decoration-color: #000000\">specific types. Be correct and concise.</span><br /><br /><span style=\"color: #000000; text-decoration-color: #000000\">Here are examples of simple </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">(</span><span style=\"color: #000000; text-decoration-color: #000000\">XML, JSON</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">)</span><span style=\"color: #000000; text-decoration-color: #000000\"> pairs that show the expected behavior:</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'two-words lower-case'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =&gt; `</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span><span style=\"color: #000000; text-decoration-color: #000000\">: </span><span style=\"color: #008000; text-decoration-color: #008000\">'example one'</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">}</span><span style=\"color: #000000; text-decoration-color: #000000\">`</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;list </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'bar'</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'upper-case'</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">list</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =&gt; `</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">\"bar\"</span><span style=\"color: #000000; text-decoration-color: #000000\">: </span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">[</span><span style=\"color: #008000; text-decoration-color: #008000\">'STRING ONE'</span><span style=\"color: #000000; text-decoration-color: #000000\">, </span><span style=\"color: #008000; text-decoration-color: #008000\">'STRING TWO'</span><span style=\"color: #000000; text-decoration-color: #000000\">, etc.</span><span style=\"color: #000000; text-decoration-color: #000000; font-weight: bold\">]}</span><span style=\"color: #000000; text-decoration-color: #000000\">`</span><br /><span style=\"color: #000000; text-decoration-color: #000000\">- `&lt;object </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">'baz'</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;string </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"foo\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"capitalize two-words\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;integer </span><span style=\"color: #808000; text-decoration-color: #808000\">name</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"index\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><span style=\"color: #808000; text-decoration-color: #808000\">format</span><span style=\"color: #000000; text-decoration-color: #000000\">=</span><span style=\"color: #008000; text-decoration-color: #008000\">\"1-indexed\"</span><span style=\"color: #000000; text-decoration-color: #000000\"> </span><br /><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;&lt;</span><span style=\"color: #800080; text-decoration-color: #800080\">/</span><span style=\"color: #ff00ff; text-decoration-color: #ff00ff\">object</span><span style=\"color: #000000; text-decoration-color: #000000\">&gt;` =</span><span style=\"font-weight: bold\">&gt;</span> `<span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'baz'</span>: <span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'foo'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'Some String'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'index'</span>: <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><span style=\"font-weight: bold\">}}</span>`<br /><br /></pre>"}} />

## Step 3: Wrap the LLM API call with `Guard`

We can now wrap the LLM API call with the `Guard` object. This will ensure that the LLM generates an output that is compliant with the RAIL spec.

To start, we test with a 'giant' as an opponent, and look at the output.


```python
import openai

raw_llm_response, validated_response = guard(
    openai.ChatCompletion.create,
    prompt_params={'opp_type': 'giant'},
    model="gpt-3.5-turbo",
    max_tokens=256,
    temperature=0.0,
)
```

<CodeOutputBlock lang="python">

```
    ---------------------------------------------------------------------------

    TypeError                                 Traceback (most recent call last)

    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:66, in PromptCallableBase.__call__(self, *args, **kwargs)
         65 try:
    ---> 66     result = self._call_llm(*args, **kwargs)
         67 except Exception as e:


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:289, in BaseRetrying.wraps.<locals>.wrapped_f(*args, **kw)
        287 @functools.wraps(f)
        288 def wrapped_f(*args: t.Any, **kw: t.Any) -> t.Any:
    --> 289     return self(f, *args, **kw)


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:379, in Retrying.__call__(self, fn, *args, **kwargs)
        378 while True:
    --> 379     do = self.iter(retry_state=retry_state)
        380     if isinstance(do, DoAttempt):


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:314, in BaseRetrying.iter(self, retry_state)
        313 if not (is_explicit_retry or self.retry(retry_state)):
    --> 314     return fut.result()
        316 if self.after is not None:


    File /usr/lib/python3.11/concurrent/futures/_base.py:449, in Future.result(self, timeout)
        448 elif self._state == FINISHED:
    --> 449     return self.__get_result()
        451 self._condition.wait(timeout)


    File /usr/lib/python3.11/concurrent/futures/_base.py:401, in Future.__get_result(self)
        400 try:
    --> 401     raise self._exception
        402 finally:
        403     # Break a reference cycle with the exception in self._exception


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:382, in Retrying.__call__(self, fn, *args, **kwargs)
        381 try:
    --> 382     result = fn(*args, **kwargs)
        383 except BaseException:  # noqa: B902


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:62, in PromptCallableBase._call_llm(self, *args, **kwargs)
         57 @retry(
         58     wait=wait_exponential_jitter(max=60),
         59     retry=retry_if_exception_type(RETRYABLE_ERRORS),
         60 )
         61 def _call_llm(self, *args, **kwargs) -> LLMResponse:
    ---> 62     return self._invoke_llm(*self.init_args, *args, **self.init_kwargs, **kwargs)


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:182, in OpenAIChatCallable._invoke_llm(self, text, model, instructions, msg_history, base_model, function_call, *args, **kwargs)
        181 api_key = kwargs.pop("api_key", os.environ.get("OPENAI_API_KEY"))
    --> 182 openai_response = openai.ChatCompletion.create(
        183     api_key=api_key,
        184     model=model,
        185     messages=chat_prompt(
        186         prompt=text, instructions=instructions, msg_history=msg_history
        187     ),
        188     *args,
        189     **fn_kwargs,
        190     **kwargs,
        191 )
        193 # Extract string from response


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/openai/api_resources/chat_completion.py:25, in ChatCompletion.create(cls, *args, **kwargs)
         24 try:
    ---> 25     return super().create(*args, **kwargs)
         26 except TryAgain as e:


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/openai/api_resources/abstract/engine_api_resource.py:153, in EngineAPIResource.create(cls, api_key, api_base, api_type, request_id, api_version, organization, **params)
        138 (
        139     deployment_id,
        140     engine,
       (...)
        150     api_key, api_base, api_type, api_version, organization, **params
        151 )
    --> 153 response, _, api_key = requestor.request(
        154     "post",
        155     url,
        156     params=params,
        157     headers=headers,
        158     stream=stream,
        159     request_id=request_id,
        160     request_timeout=request_timeout,
        161 )
        163 if stream:
        164     # must be an iterator


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/openai/api_requestor.py:288, in APIRequestor.request(self, method, url, params, headers, files, stream, request_id, request_timeout)
        277 def request(
        278     self,
        279     method,
       (...)
        286     request_timeout: Optional[Union[float, Tuple[float, float]]] = None,
        287 ) -> Tuple[Union[OpenAIResponse, Iterator[OpenAIResponse]], bool, str]:
    --> 288     result = self.request_raw(
        289         method.lower(),
        290         url,
        291         params=params,
        292         supplied_headers=headers,
        293         files=files,
        294         stream=stream,
        295         request_id=request_id,
        296         request_timeout=request_timeout,
        297     )
        298     resp, got_stream = self._interpret_response(result, stream)


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/openai/api_requestor.py:581, in APIRequestor.request_raw(self, method, url, params, supplied_headers, files, stream, request_id, request_timeout)
        569 def request_raw(
        570     self,
        571     method,
       (...)
        579     request_timeout: Optional[Union[float, Tuple[float, float]]] = None,
        580 ) -> requests.Response:
    --> 581     abs_url, headers, data = self._prepare_request_raw(
        582         url, supplied_headers, method, params, files, request_id
        583     )
        585     if not hasattr(_thread_context, "session"):


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/openai/api_requestor.py:553, in APIRequestor._prepare_request_raw(self, url, supplied_headers, method, params, files, request_id)
        552 if params and not files:
    --> 553     data = json.dumps(params).encode()
        554     headers["Content-Type"] = "application/json"


    File /usr/lib/python3.11/json/__init__.py:231, in dumps(obj, skipkeys, ensure_ascii, check_circular, allow_nan, cls, indent, separators, default, sort_keys, **kw)
        227 if (not skipkeys and ensure_ascii and
        228     check_circular and allow_nan and
        229     cls is None and indent is None and separators is None and
        230     default is None and not sort_keys and not kw):
    --> 231     return _default_encoder.encode(obj)
        232 if cls is None:


    File /usr/lib/python3.11/json/encoder.py:200, in JSONEncoder.encode(self, o)
        197 # This doesn't pass the iterator directly to ''.join() because the
        198 # exceptions aren't as detailed.  The list call should be roughly
        199 # equivalent to the PySequence_Fast that ''.join() would do.
    --> 200 chunks = self.iterencode(o, _one_shot=True)
        201 if not isinstance(chunks, (list, tuple)):


    File /usr/lib/python3.11/json/encoder.py:258, in JSONEncoder.iterencode(self, o, _one_shot)
        254     _iterencode = _make_iterencode(
        255         markers, self.default, _encoder, self.indent, floatstr,
        256         self.key_separator, self.item_separator, self.sort_keys,
        257         self.skipkeys, _one_shot)
    --> 258 return _iterencode(o, 0)


    File /usr/lib/python3.11/json/encoder.py:180, in JSONEncoder.default(self, o)
        162 """Implement this method in a subclass such that it returns
        163 a serializable object for ``o``, or calls the base implementation
        164 (to raise a ``TypeError``).
       (...)
        178 
        179 """
    --> 180 raise TypeError(f'Object of type {o.__class__.__name__} '
        181                 f'is not JSON serializable')


    TypeError: Object of type ValidChoices is not JSON serializable

    
    During handling of the above exception, another exception occurred:


    PromptCallableException                   Traceback (most recent call last)

    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/run.py:336, in Runner.call(self, index, instructions, prompt, msg_history, api, output)
        335 if prompt and instructions:
    --> 336     llm_response = api(
        337         prompt.source,
        338         instructions=instructions.source,
        339         base_model=self.base_model,
        340     )
        341 elif prompt:


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:68, in PromptCallableBase.__call__(self, *args, **kwargs)
         67 except Exception as e:
    ---> 68     raise PromptCallableException(
         69         "The callable `fn` passed to `Guard(fn, ...)` failed"
         70         f" with the following error: `{e}`. "
         71         "Make sure that `fn` can be called as a function that"
         72         " takes in a single prompt string "
         73         "and returns a string."
         74     )
         75 if not isinstance(result, LLMResponse):


    PromptCallableException: The callable `fn` passed to `Guard(fn, ...)` failed with the following error: `Object of type ValidChoices is not JSON serializable`. Make sure that `fn` can be called as a function that takes in a single prompt string and returns a string.

    
    During handling of the above exception, another exception occurred:


    KeyError                                  Traceback (most recent call last)

    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:66, in PromptCallableBase.__call__(self, *args, **kwargs)
         65 try:
    ---> 66     result = self._call_llm(*args, **kwargs)
         67 except Exception as e:


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:289, in BaseRetrying.wraps.<locals>.wrapped_f(*args, **kw)
        287 @functools.wraps(f)
        288 def wrapped_f(*args: t.Any, **kw: t.Any) -> t.Any:
    --> 289     return self(f, *args, **kw)


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:379, in Retrying.__call__(self, fn, *args, **kwargs)
        378 while True:
    --> 379     do = self.iter(retry_state=retry_state)
        380     if isinstance(do, DoAttempt):


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:314, in BaseRetrying.iter(self, retry_state)
        313 if not (is_explicit_retry or self.retry(retry_state)):
    --> 314     return fut.result()
        316 if self.after is not None:


    File /usr/lib/python3.11/concurrent/futures/_base.py:449, in Future.result(self, timeout)
        448 elif self._state == FINISHED:
    --> 449     return self.__get_result()
        451 self._condition.wait(timeout)


    File /usr/lib/python3.11/concurrent/futures/_base.py:401, in Future.__get_result(self)
        400 try:
    --> 401     raise self._exception
        402 finally:
        403     # Break a reference cycle with the exception in self._exception


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/tenacity/__init__.py:382, in Retrying.__call__(self, fn, *args, **kwargs)
        381 try:
    --> 382     result = fn(*args, **kwargs)
        383 except BaseException:  # noqa: B902


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:62, in PromptCallableBase._call_llm(self, *args, **kwargs)
         57 @retry(
         58     wait=wait_exponential_jitter(max=60),
         59     retry=retry_if_exception_type(RETRYABLE_ERRORS),
         60 )
         61 def _call_llm(self, *args, **kwargs) -> LLMResponse:
    ---> 62     return self._invoke_llm(*self.init_args, *args, **self.init_kwargs, **kwargs)


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:203, in OpenAIChatCallable._invoke_llm(self, text, model, instructions, msg_history, base_model, function_call, *args, **kwargs)
        199     output = openai_response["choices"][0]["message"]["content"]
        201 return LLMResponse(
        202     output=output,
    --> 203     prompt_token_count=openai_response["choices"][0]["tokens"],
        204     response_token_count=openai_response["choices"][0]["tokens"],
        205 )


    KeyError: 'tokens'

    
    During handling of the above exception, another exception occurred:


    PromptCallableException                   Traceback (most recent call last)

    Cell In[12], line 3
          1 import openai
    ----> 3 raw_llm_response, validated_response = guard(
          4     openai.ChatCompletion.create,
          5     prompt_params={'opp_type': 'giant'},
          6     model="gpt-3.5-turbo",
          7     max_tokens=256,
          8     temperature=0.0,
          9 )


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/guard.py:270, in Guard.__call__(self, llm_api, prompt_params, num_reasks, prompt, instructions, msg_history, metadata, full_schema_reask, *args, **kwargs)
        257     return self._call_async(
        258         llm_api,
        259         prompt_params=prompt_params,
       (...)
        267         **kwargs,
        268     )
        269 # Otherwise, call the LLM synchronously
    --> 270 return self._call_sync(
        271     llm_api,
        272     prompt_params=prompt_params,
        273     num_reasks=self.num_reasks,
        274     prompt=prompt,
        275     instructions=instructions,
        276     msg_history=msg_history,
        277     metadata=metadata,
        278     full_schema_reask=full_schema_reask,
        279     *args,
        280     **kwargs,
        281 )


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/guard.py:322, in Guard._call_sync(self, llm_api, prompt_params, num_reasks, prompt, instructions, msg_history, metadata, full_schema_reask, *args, **kwargs)
        306 with start_action(action_type="guard_call", prompt_params=prompt_params):
        307     runner = Runner(
        308         instructions=instructions,
        309         prompt=prompt,
       (...)
        320         full_schema_reask=full_schema_reask,
        321     )
    --> 322     guard_history = runner(prompt_params=prompt_params)
        323     return guard_history.output, guard_history.validated_output


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/run.py:141, in Runner.__call__(self, prompt_params)
        132 instructions, prompt, msg_history, input_schema, output_schema = (
        133     self.instructions,
        134     self.prompt,
       (...)
        137     self.output_schema,
        138 )
        139 for index in range(self.num_reasks + 1):
        140     # Run a single step.
    --> 141     validated_output, reasks = self.step(
        142         index=index,
        143         api=self.api,
        144         instructions=instructions,
        145         prompt=prompt,
        146         msg_history=msg_history,
        147         prompt_params=prompt_params,
        148         input_schema=input_schema,
        149         output_schema=output_schema,
        150         output=self.output if index == 0 else None,
        151     )
        153     # Loop again?
        154     if not self.do_loop(index, reasks):


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/run.py:213, in Runner.step(self, index, api, instructions, prompt, msg_history, prompt_params, input_schema, output_schema, output)
        210 guard_logs.msg_history = msg_history
        212 # Call: run the API.
    --> 213 llm_response = self.call(
        214     index, instructions, prompt, msg_history, api, output
        215 )
        217 guard_logs.llm_response = llm_response
        218 output = llm_response.output


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/run.py:349, in Runner.call(self, index, instructions, prompt, msg_history, api, output)
        347 else:
        348     if prompt and instructions:
    --> 349         llm_response = api(
        350             prompt.source, instructions=instructions.source
        351         )
        352     elif prompt:
        353         llm_response = api(prompt.source)


    File ~/workspace/shreya/guardrails/.venv/lib/python3.11/site-packages/guardrails/llm_providers.py:68, in PromptCallableBase.__call__(self, *args, **kwargs)
         66     result = self._call_llm(*args, **kwargs)
         67 except Exception as e:
    ---> 68     raise PromptCallableException(
         69         "The callable `fn` passed to `Guard(fn, ...)` failed"
         70         f" with the following error: `{e}`. "
         71         "Make sure that `fn` can be called as a function that"
         72         " takes in a single prompt string "
         73         "and returns a string."
         74     )
         75 if not isinstance(result, LLMResponse):
         76     raise PromptCallableException(
         77         "The callable `fn` passed to `Guard(fn, ...)` returned"
         78         f" a non-string value: {result}. "
       (...)
         81         "and returns a string."
         82     )


    PromptCallableException: The callable `fn` passed to `Guard(fn, ...)` failed with the following error: `'tokens'`. Make sure that `fn` can be called as a function that takes in a single prompt string and returns a string.
```

</CodeOutputBlock>

Running the cell above returns:
1. The raw LLM text output as a single string.
2. A dictionary where the key is `python_code` and the value is the generated code.

We can see that if the LLM chooses `flight`, the output is a dictionary with `flight_direction` and `distance` fields.


```python
print(validated_response)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'action'</span>: <span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'chosen_action'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'flight'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'flight_direction'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'north'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'distance'</span>: <span style=\"color: #008080; text-decoration-color: #008080; font-weight: bold\">1</span><span style=\"font-weight: bold\">}}</span><br /></pre>"}} />

We can inspect the logs of the guard object to see the quality criteria that were checked and the corrective actions that were taken.


```python
print(guard.state.most_recent_call.tree)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Logs<br />└── ╭────────────────────────────────────────────────── Step 0 ───────────────────────────────────────────────────╮<br />    │ <span style=\"background-color: #f0f8ff\">╭──────────────────────────────────────────────── Prompt ─────────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ You are a human in an enchanted forest. You come across opponents of different types, and you should    │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ fight smaller opponents and run away from bigger ones.                                                  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ You run into a giant. What do you do?                                                                   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Given below is XML that describes the information to extract from this document and the tags to extract │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ it into.                                                                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ &lt;output&gt;                                                                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     &lt;choice name=\"action\" discriminator=\"chosen_action\"&gt;                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;case name=\"fight\"&gt;                                                                             │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│             &lt;string name=\"weapon\" format=\"valid-choices: choices=['crossbow', 'machine gun']\"/&gt;         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;/case&gt;                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;case name=\"flight\"&gt;                                                                            │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│             &lt;string name=\"flight_direction\" format=\"valid-choices: choices=['north', 'south', 'east',   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ 'west']\"/&gt;                                                                                              │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│             &lt;integer name=\"distance\" format=\"valid-choices: choices=[1, 2, 3, 4]\"/&gt;                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;/case&gt;                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     &lt;/choice&gt;                                                                                           │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ &lt;/output&gt;                                                                                               │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ ONLY return a valid JSON object (no other text is necessary), where the key of the field in JSON is the │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ `name` attribute of the corresponding XML, and the value is of the type specified by the corresponding  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ XML's tag. The JSON MUST conform to the XML format, including any types and format requests e.g.        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ requests for lists, objects and specific types. Be correct and concise.                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Here are examples of simple (XML, JSON) pairs that show the expected behavior:                          │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE', 'STRING TWO',     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ etc.]}`                                                                                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer name=\"index\"          │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index': 1}}`                        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #fff0f2\">╭───────────────────────────────────────────── Instructions ──────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #fff0f2\">│ You are a helpful assistant, able to express yourself purely through JSON, strictly and precisely       │</span> │<br />    │ <span style=\"background-color: #fff0f2\">│ adhering to the provided XML schemas.                                                                   │</span> │<br />    │ <span style=\"background-color: #fff0f2\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #e7dfeb\">╭──────────────────────────────────────────── Message History ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┏━━━━━━┳━━━━━━━━━┓                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Role </span><span style=\"background-color: #e7dfeb\">┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Content </span><span style=\"background-color: #e7dfeb\">┃                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┡━━━━━━╇━━━━━━━━━┩                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ └──────┴─────────┘                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   \"action\": {                                                                                           │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"chosen_action\": \"flight\",                                                                          │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"flight_direction\": \"north\",                                                                        │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"distance\": 1                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   }                                                                                                     │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     'action': {                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'chosen_action': 'flight',                                                                      │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'flight_direction': 'north',                                                                    │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│         'distance': 1                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│     }                                                                                                   │</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br /></pre>"}} />

Now, let's test with a `goblin` as an opponent.

We can see that the LLM chose to `fight` and the output is a choice of `weapon`.


```python
raw_llm_response, validated_response = guard(
    openai.ChatCompletion.create,
    prompt_params={'opp_type': 'goblin'},
    model="gpt-3.5-turbo",
    max_tokens=256,
    temperature=0.0,
)
```

<CodeOutputBlock lang="python">

```
    Async event loop found, but guard was invoked synchronously.For validator parallelization, please call `validate_async` instead.
```

</CodeOutputBlock>


```python
print(validated_response)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\"><span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'action'</span>: <span style=\"font-weight: bold\">{</span><span style=\"color: #008000; text-decoration-color: #008000\">'chosen_action'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'fight'</span>, <span style=\"color: #008000; text-decoration-color: #008000\">'weapon'</span>: <span style=\"color: #008000; text-decoration-color: #008000\">'crossbow'</span><span style=\"font-weight: bold\">}}</span><br /></pre>"}} />

We can inspect the state of the guard after each call to see what happened.


```python
print(guard.state.most_recent_call.tree)
```
    
<CodeOutputBlock dangerouslySetInnerHTML={{ __html: "<pre style=\"white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace\">Logs<br />└── ╭────────────────────────────────────────────────── Step 0 ───────────────────────────────────────────────────╮<br />    │ <span style=\"background-color: #f0f8ff\">╭──────────────────────────────────────────────── Prompt ─────────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ You are a human in an enchanted forest. You come across opponents of different types, and you should    │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ fight smaller opponents and run away from bigger ones.                                                  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ You run into a goblin. What do you do?                                                                  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Given below is XML that describes the information to extract from this document and the tags to extract │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ it into.                                                                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ &lt;output&gt;                                                                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     &lt;choice name=\"action\" discriminator=\"chosen_action\"&gt;                                                │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;case name=\"fight\"&gt;                                                                             │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│             &lt;string name=\"weapon\" format=\"valid-choices: choices=['crossbow', 'machine gun']\"/&gt;         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;/case&gt;                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;case name=\"flight\"&gt;                                                                            │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│             &lt;string name=\"flight_direction\" format=\"valid-choices: choices=['north', 'south', 'east',   │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ 'west']\"/&gt;                                                                                              │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│             &lt;integer name=\"distance\" format=\"valid-choices: choices=[1, 2, 3, 4]\"/&gt;                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│         &lt;/case&gt;                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│     &lt;/choice&gt;                                                                                           │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ &lt;/output&gt;                                                                                               │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ ONLY return a valid JSON object (no other text is necessary), where the key of the field in JSON is the │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ `name` attribute of the corresponding XML, and the value is of the type specified by the corresponding  │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ XML's tag. The JSON MUST conform to the XML format, including any types and format requests e.g.        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ requests for lists, objects and specific types. Be correct and concise.                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ Here are examples of simple (XML, JSON) pairs that show the expected behavior:                          │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;string name='foo' format='two-words lower-case' /&gt;` =&gt; `{'foo': 'example one'}`                     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;list name='bar'&gt;&lt;string format='upper-case' /&gt;&lt;/list&gt;` =&gt; `{\"bar\": ['STRING ONE', 'STRING TWO',     │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ etc.]}`                                                                                                 │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ - `&lt;object name='baz'&gt;&lt;string name=\"foo\" format=\"capitalize two-words\" /&gt;&lt;integer name=\"index\"          │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│ format=\"1-indexed\" /&gt;&lt;/object&gt;` =&gt; `{'baz': {'foo': 'Some String', 'index': 1}}`                        │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">│                                                                                                         │</span> │<br />    │ <span style=\"background-color: #f0f8ff\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #fff0f2\">╭───────────────────────────────────────────── Instructions ──────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #fff0f2\">│ You are a helpful assistant, able to express yourself purely through JSON, strictly and precisely       │</span> │<br />    │ <span style=\"background-color: #fff0f2\">│ adhering to the provided XML schemas.                                                                   │</span> │<br />    │ <span style=\"background-color: #fff0f2\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #e7dfeb\">╭──────────────────────────────────────────── Message History ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┏━━━━━━┳━━━━━━━━━┓                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Role </span><span style=\"background-color: #e7dfeb\">┃</span><span style=\"background-color: #e7dfeb; font-weight: bold\"> Content </span><span style=\"background-color: #e7dfeb\">┃                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ ┡━━━━━━╇━━━━━━━━━┩                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">│ └──────┴─────────┘                                                                                      │</span> │<br />    │ <span style=\"background-color: #e7dfeb\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╭──────────────────────────────────────────── Raw LLM Output ─────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ {                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   \"action\": {                                                                                           │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"chosen_action\": \"fight\",                                                                           │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│     \"weapon\": \"crossbow\"                                                                                │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│   }                                                                                                     │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">│ }                                                                                                       │</span> │<br />    │ <span style=\"background-color: #f5f5dc\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    │ <span style=\"background-color: #f0fff0\">╭─────────────────────────────────────────── Validated Output ────────────────────────────────────────────╮</span> │<br />    │ <span style=\"background-color: #f0fff0\">│ {'action': {'chosen_action': 'fight', 'weapon': 'crossbow'}}                                            │</span> │<br />    │ <span style=\"background-color: #f0fff0\">╰─────────────────────────────────────────────────────────────────────────────────────────────────────────╯</span> │<br />    ╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────╯<br /></pre>"}} />
